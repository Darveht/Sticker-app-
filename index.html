<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StickerToons Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Rubik:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cn-cyan': '#00AEEF',
                        'cn-magenta': '#EC008C',
                        'cn-yellow': '#FFF200',
                        'cn-black': '#000000',
                        'cn-white': '#FFFFFF',
                    },
                    fontFamily: {
                        'comic': ['Bangers', 'cursive'],
                        'ui': ['Rubik', 'sans-serif'],
                    },
                    boxShadow: {
                        'hard': '6px 6px 0px 0px #000000',
                        'hard-sm': '3px 3px 0px 0px #000000',
                        'hard-hover': '2px 2px 0px 0px #000000',
                    }
                }
            }
        }
    </script>

    <style>
        /* ESTILOS GLOBALES Y PATRONES */
        body {
            background-color: #00AEEF;
            overflow: hidden; /* Evitar scroll global */
        }

        /* Patrón de puntos estilo cómic (Halftone) */
        .halftone-bg {
            background-image: radial-gradient(#000 20%, transparent 20%), radial-gradient(#000 20%, transparent 20%);
            background-color: #00AEEF;
            background-position: 0 0, 5px 5px;
            background-size: 10px 10px;
            opacity: 0.1;
            position: absolute;
            inset: 0;
            z-index: -1;
        }

        /* Bordes gruesos */
        .border-comic {
            border: 4px solid black;
        }

        /* Animaciones */
        @keyframes wobble {
            0% { transform: rotate(0deg); }
            15% { transform: rotate(-3deg); }
            30% { transform: rotate(2deg); }
            45% { transform: rotate(-1deg); }
            60% { transform: rotate(1deg); }
            100% { transform: rotate(0deg); }
        }

        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            70% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }

        .animate-wobble-hover:hover {
            animation: wobble 0.5s ease-in-out;
        }
        
        .pop-in {
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Utilidad para ocultar pantallas */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            position: absolute;
            top: 0;
            left: 0;
            background: white;
            transition: opacity 0.25s ease-in-out;
            overflow: hidden;
        }
        
        .screen.active {
            display: flex;
        }
        
        /* Asegurar que headers siempre estén arriba */
        .screen header {
            position: relative;
            z-index: 50;
            flex-shrink: 0;
        }

        /* Input Styles */
        .comic-input {
            border: 3px solid black;
            box-shadow: 4px 4px 0px 0px black;
            font-family: 'Rubik', sans-serif;
            font-weight: bold;
            outline: none;
            transition: all 0.2s;
        }
        .comic-input:focus {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0px 0px #EC008C;
        }

        /* Checkered Canvas Background */
        .canvas-wrapper {
            background-color: #fff;
            background-image: 
                linear-gradient(45deg, #ddd 25%, transparent 25%), 
                linear-gradient(-45deg, #ddd 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ddd 75%), 
                linear-gradient(-45deg, transparent 75%, #ddd 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        /* Progress bar animation */
        @keyframes progress {
            0% { width: 0%; }
            100% { width: 100%; }
        }
    </style>
</head>
<body class="text-cn-black h-screen w-screen overflow-hidden select-none">

    <!-- BACKGROUND PATTERN -->
    <div class="halftone-bg"></div>

    <!-- =======================
         1. SPLASH SCREEN (INTRO) 
         ======================= -->
    <section id="screen-splash" class="screen active z-50 bg-cn-yellow flex items-center justify-center">
        <div class="text-center">
            <div class="relative inline-block mb-4 animate-bounce">
                <i data-lucide="zap" class="w-32 h-32 fill-cn-cyan text-black stroke-[3]"></i>
                <div class="absolute -top-2 -right-4 bg-white border-comic px-2 py-1 transform rotate-12">
                    <span class="font-comic text-xl">v2.1</span>
                </div>
            </div>
            <h1 class="font-comic text-6xl tracking-wider uppercase text-cn-magenta drop-shadow-[4px_4px_0_#000]">
                Sticker<br><span class="text-cn-cyan">Toons</span>
            </h1>
            <p class="font-ui font-bold mt-4 text-xl loading-dots">Cargando Motor Creativo</p>
        </div>
    </section>

    <!-- =======================
         2. LOGIN SCREEN
         ======================= -->
    <section id="screen-login" class="screen z-40 bg-cn-cyan flex flex-col">
        <header class="bg-cn-yellow border-b-4 border-black p-4 text-center">
            <h2 class="font-comic text-4xl">STICKERTOONS</h2>
        </header>
        
        <div class="flex-1 flex items-center justify-center p-6 overflow-y-auto">
            <div class="w-full max-w-md">
                <div class="bg-white border-comic p-8 shadow-hard">
                    <div class="text-center mb-6">
                        <i data-lucide="zap" class="w-20 h-20 mx-auto mb-4 fill-cn-cyan text-black stroke-[3]"></i>
                        <h2 class="font-comic text-3xl text-cn-magenta">BIENVENIDO</h2>
                    </div>
                
                <div id="login-form" class="space-y-4">
                    <input type="email" id="login-email" placeholder="Email" class="comic-input w-full p-3 rounded-none">
                    <input type="password" id="login-password" placeholder="Contraseña" class="comic-input w-full p-3 rounded-none">
                    <button onclick="app.login()" class="w-full bg-cn-magenta text-white border-comic py-3 font-comic text-xl shadow-hard hover:translate-y-1 hover:shadow-none transition-all">
                        ENTRAR
                    </button>
                    <button onclick="app.showRegister()" class="w-full bg-cn-yellow text-black border-comic py-3 font-comic text-xl shadow-hard hover:translate-y-1 hover:shadow-none transition-all">
                        REGISTRARSE
                    </button>
                    <button onclick="app.resetPassword()" class="w-full text-center font-ui font-bold text-sm text-gray-600 hover:text-cn-magenta">
                        ¿Olvidaste tu contraseña?
                    </button>
                </div>
                
                <div id="register-form" class="space-y-4 hidden">
                    <input type="email" id="register-email" placeholder="Email" class="comic-input w-full p-3 rounded-none">
                    <input type="password" id="register-password" placeholder="Contraseña" class="comic-input w-full p-3 rounded-none">
                    <input type="password" id="register-confirm" placeholder="Confirmar Contraseña" class="comic-input w-full p-3 rounded-none">
                    <button onclick="app.register()" class="w-full bg-cn-cyan text-white border-comic py-3 font-comic text-xl shadow-hard hover:translate-y-1 hover:shadow-none transition-all">
                        CREAR CUENTA
                    </button>
                    <button onclick="app.showLogin()" class="w-full text-center font-ui font-bold text-sm text-gray-600 hover:text-cn-cyan">
                        Ya tengo cuenta
                    </button>
                </div>
                </div>
            </div>
        </div>
    </section>

    <!-- =======================
         3. HOME SCREEN (MENU)
         ======================= -->
    <section id="screen-home" class="screen z-30 bg-white flex flex-col">
        <!-- Header -->
        <header class="bg-cn-yellow border-b-4 border-black p-4 flex justify-between items-center shadow-hard-sm">
            <div class="flex items-center gap-2">
                <div class="bg-black text-white p-1 rounded-sm"><i data-lucide="ghost" class="w-6 h-6"></i></div>
                <h2 class="font-comic text-3xl">MENU PRINCIPAL</h2>
            </div>
            <!-- Botón de menú -->
            <button onclick="nav.to('menu')" class="bg-cn-cyan text-white p-2 border-2 border-black shadow-hard-hover active:translate-y-1 active:shadow-none hover:bg-cyan-400 transition-colors">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
        </header>

        <!-- Menu Grid -->
        <div class="flex-1 p-6 flex flex-col justify-center gap-6 overflow-y-auto">
            
            <!-- Card: AI Generator -->
            <div onclick="nav.to('ai')" class="cursor-pointer group relative bg-cn-cyan border-comic shadow-hard p-6 flex flex-col items-center hover:bg-cyan-400 transition-colors">
                <div class="absolute -top-4 -right-4 bg-cn-magenta text-white border-comic px-3 py-1 font-comic rotate-6 z-10">
                    ¡POPULAR!
                </div>
                <i data-lucide="brain-circuit" class="w-20 h-20 mb-4 text-white stroke-[3] group-hover:scale-110 transition-transform"></i>
                <h3 class="font-comic text-4xl text-white text-stroke-black">CREAR CON IA</h3>
                <p class="font-ui font-bold text-center mt-2 bg-white/30 p-2 border-2 border-black text-sm">Describe y crea stickers únicos con inteligencia artificial.</p>
            </div>

            <!-- Card: Gallery -->
            <div onclick="document.getElementById('file-input').click()" class="cursor-pointer bg-cn-yellow border-comic shadow-hard p-6 flex flex-col items-center hover:bg-yellow-300 transition-colors">
                <i data-lucide="image-plus" class="w-20 h-20 mb-4 text-black stroke-[3]"></i>
                <h3 class="font-comic text-4xl text-black">SUBIR FOTO</h3>
                <p class="font-ui font-bold text-center mt-2 bg-white/30 p-2 border-2 border-black text-sm">Usa fotos de tu galería.</p>
                <input type="file" id="file-input" class="hidden" accept="image/*" onchange="app.handleUpload(event)">
            </div>

            <!-- Card: Mis Creaciones -->
            <div onclick="nav.to('gallery')" class="cursor-pointer bg-white border-comic shadow-hard p-6 flex flex-col items-center hover:bg-gray-100 transition-colors">
                <i data-lucide="images" class="w-20 h-20 mb-4 text-cn-magenta stroke-[3]"></i>
                <h3 class="font-comic text-4xl text-cn-magenta">MIS CREACIONES</h3>
                <p class="font-ui font-bold text-center mt-2 bg-gray-100 p-2 border-2 border-black text-sm">Ve tus stickers guardados.</p>
            </div>

        </div>
    </section>

    <!-- =======================
         3. MENU SCREEN
         ======================= -->
    <section id="screen-menu" class="screen z-30 bg-white flex flex-col">
        <header class="bg-cn-yellow border-b-4 border-black p-4 flex items-center gap-3">
            <button onclick="nav.back()" class="bg-white text-black p-2 border-comic rounded-full hover:scale-110 transition-transform shadow-hard-sm">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="font-comic text-3xl tracking-wide">MENÚ</h2>
        </header>

        <div class="flex-1 p-6 overflow-y-auto">
            <div class="space-y-4">
                <div onclick="nav.to('settings')" class="cursor-pointer bg-cn-cyan border-comic shadow-hard p-4 flex items-center gap-4 hover:bg-cyan-400 transition-colors">
                    <i data-lucide="settings" class="w-12 h-12 text-white stroke-[3]"></i>
                    <div class="flex-1">
                        <h3 class="font-comic text-2xl text-white">AJUSTES</h3>
                        <p class="font-ui font-bold text-white/80">Personaliza la app</p>
                    </div>
                </div>
                
                <div onclick="nav.to('help')" class="cursor-pointer bg-green-400 border-comic shadow-hard p-4 flex items-center gap-4 hover:bg-green-500 transition-colors">
                    <i data-lucide="help-circle" class="w-12 h-12 text-white stroke-[3]"></i>
                    <div class="flex-1">
                        <h3 class="font-comic text-2xl text-white">AYUDA</h3>
                        <p class="font-ui font-bold text-white/80">Guías y tutoriales</p>
                    </div>
                </div>
                
                <div onclick="nav.to('contact')" class="cursor-pointer bg-cn-magenta border-comic shadow-hard p-4 flex items-center gap-4 hover:bg-pink-600 transition-colors">
                    <i data-lucide="mail" class="w-12 h-12 text-white stroke-[3]"></i>
                    <div class="flex-1">
                        <h3 class="font-comic text-2xl text-white">CONTACTO</h3>
                        <p class="font-ui font-bold text-white/80">Reportar problemas</p>
                    </div>
                </div>
                
                <div onclick="nav.to('rate')" class="cursor-pointer bg-cn-yellow border-comic shadow-hard p-4 flex items-center gap-4 hover:bg-yellow-300 transition-colors">
                    <i data-lucide="star" class="w-12 h-12 text-black stroke-[3]"></i>
                    <div class="flex-1">
                        <h3 class="font-comic text-2xl text-black">CALIFICAR APP</h3>
                        <p class="font-ui font-bold text-black/80">Danos tu opinión</p>
                    </div>
                </div>
                
                <div onclick="nav.to('about')" class="cursor-pointer bg-white border-comic shadow-hard p-4 flex items-center gap-4 hover:bg-gray-100 transition-colors">
                    <i data-lucide="info" class="w-12 h-12 text-cn-cyan stroke-[3]"></i>
                    <div class="flex-1">
                        <h3 class="font-comic text-2xl text-cn-cyan">ACERCA DE</h3>
                        <p class="font-ui font-bold text-gray-600">Versión y créditos</p>
                    </div>
                </div>
                
                <div onclick="app.logout()" class="cursor-pointer bg-red-500 border-comic shadow-hard p-4 flex items-center gap-4 hover:bg-red-600 transition-colors">
                    <i data-lucide="log-out" class="w-12 h-12 text-white stroke-[3]"></i>
                    <div class="flex-1">
                        <h3 class="font-comic text-2xl text-white">CERRAR SESIÓN</h3>
                        <p class="font-ui font-bold text-white/80">Salir de la cuenta</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- =======================
         4. GALLERY SCREEN (MIS CREACIONES)
         ======================= -->
    <section id="screen-gallery" class="screen z-30 bg-cn-magenta flex flex-col">
        <header class="bg-cn-yellow border-b-4 border-black p-4 flex items-center gap-3">
            <button onclick="nav.back()" class="bg-white text-black p-2 border-comic rounded-full hover:scale-110 transition-transform shadow-hard-sm">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="font-comic text-3xl tracking-wide">MIS CREACIONES</h2>
        </header>

        <div class="flex-1 p-6 overflow-y-auto">
            <div id="gallery-content" class="grid grid-cols-2 gap-4">
                <!-- Los stickers se cargarán aquí dinámicamente -->
            </div>
            
            <!-- Mensaje cuando no hay stickers -->
            <div id="empty-gallery" class="flex flex-col items-center justify-center h-full">
                <div class="bg-white border-comic p-8 text-center shadow-hard max-w-sm">
                    <i data-lucide="image-off" class="w-24 h-24 mx-auto mb-4 text-gray-400"></i>
                    <h3 class="font-comic text-3xl mb-3">AÚN NO HAY STICKERS</h3>
                    <p class="font-ui font-bold text-lg mb-6">Crea tu primer sticker y aparecerá aquí</p>
                    <button onclick="nav.to('home')" class="bg-cn-cyan text-white border-comic px-6 py-3 font-comic text-xl shadow-hard hover:translate-y-1 hover:shadow-none transition-all">
                        CREAR AHORA
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- =======================
         5. AI GENERATOR SCREEN
         ======================= -->
    <section id="screen-ai" class="screen z-30 bg-cn-magenta flex flex-col">
        <header class="bg-black text-white p-4 flex items-center gap-3">
            <button onclick="nav.back()" class="bg-white text-black p-2 border-comic rounded-full hover:scale-110 transition-transform shadow-hard-sm">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="font-comic text-3xl tracking-wide">LABORATORIO DE STICKERS</h2>
        </header>

        <div class="flex-1 p-6 flex flex-col gap-6 justify-center overflow-y-auto" style="padding-top: 2rem;">
            
            <div class="bg-white border-comic p-4 shadow-hard">
                <label class="font-comic text-2xl block mb-2">¿QUÉ VAMOS A CREAR?</label>
                <textarea id="ai-prompt" rows="4" class="w-full bg-gray-100 border-2 border-black p-3 font-ui text-lg focus:bg-white transition-colors outline-none resize-none" placeholder="Ej: Un gato zombie comiendo pizza radioactiva..."></textarea>
            </div>
            
            <!-- Imagen de referencia -->
            <div class="bg-cn-yellow border-comic p-4 shadow-hard">
                <label class="font-comic text-xl block mb-3">IMAGEN DE REFERENCIA (Opcional)</label>
                <div class="flex gap-3">
                    <button onclick="document.getElementById('reference-input').click()" class="flex-1 bg-white border-2 border-black p-3 font-ui font-bold hover:bg-gray-100 transition-colors flex items-center justify-center gap-2">
                        <i data-lucide="image-plus" class="w-5 h-5"></i>
                        SUBIR IMAGEN
                    </button>
                    <button onclick="app.clearReference()" class="bg-red-500 text-white border-2 border-black p-3 font-ui font-bold hover:bg-red-600 transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <input type="file" id="reference-input" class="hidden" accept="image/*" onchange="app.loadReference(event)">
                <div id="reference-preview" class="hidden mt-3 border-2 border-black bg-white p-2">
                    <img id="reference-img" class="w-full h-32 object-contain">
                </div>
            </div>
            
            <!-- Modo de generación -->
            <div class="bg-white border-comic p-4 shadow-hard">
                <label class="font-comic text-xl block mb-3">MODO DE GENERACIÓN</label>
                <div class="grid grid-cols-2 gap-3">
                    <button id="mode-new" onclick="app.setGenerationMode('new')" class="generation-mode active bg-cn-cyan text-white border-2 border-black p-3 font-comic text-lg shadow-hard-sm">
                        NUEVO
                    </button>
                    <button id="mode-modify" onclick="app.setGenerationMode('modify')" class="generation-mode bg-gray-300 text-black border-2 border-black p-3 font-comic text-lg shadow-hard-sm">
                        MODIFICAR
                    </button>
                </div>
                <p class="font-ui text-sm mt-2 text-gray-600">
                    <span id="mode-description">Crear un sticker completamente nuevo</span>
                </p>
            </div>

            <div class="flex flex-wrap gap-2">
                <span onclick="app.setPrompt('cute cat with sunglasses')" class="bg-cn-yellow border-2 border-black px-3 py-1 font-bold cursor-pointer text-sm hover:scale-105 transition-transform">#GatoCool</span>
                <span onclick="app.setPrompt('happy pizza slice')" class="bg-cn-cyan border-2 border-black px-3 py-1 font-bold cursor-pointer text-sm hover:scale-105 transition-transform">#Pizza</span>
                <span onclick="app.setPrompt('kawaii unicorn')" class="bg-white border-2 border-black px-3 py-1 font-bold cursor-pointer text-sm hover:scale-105 transition-transform">#Unicornio</span>
                <span onclick="app.setPrompt('smiling avocado')" class="bg-cn-magenta border-2 border-black px-3 py-1 font-bold cursor-pointer text-sm hover:scale-105 text-white transition-transform">#Aguacate</span>
            </div>

            <button onclick="app.generateAI()" class="mt-4 bg-cn-yellow text-black border-comic shadow-hard py-4 px-6 font-comic text-3xl hover:translate-y-1 hover:shadow-none transition-all flex items-center justify-center gap-3">
                <i data-lucide="wand-2" class="w-8 h-8"></i>
                ¡GENERAR AHORA!
            </button>
            
            <!-- Loading Indicator Inside -->
            <div id="ai-loader" class="hidden text-center mt-4">
                <div class="bg-white border-comic p-6 shadow-hard">
                    <i data-lucide="loader" class="w-16 h-16 animate-spin mx-auto text-cn-magenta mb-4"></i>
                    <p class="font-comic text-2xl mb-2">GENERANDO...</p>
                    <p class="font-ui font-bold text-sm">Esto puede tomar 10-15 segundos</p>
                    <div class="mt-4 bg-gray-200 h-2 rounded-full overflow-hidden">
                        <div class="progress-bar bg-cn-cyan h-full rounded-full" style="width: 0%; animation: progress 15s linear forwards;"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- =======================
         6. SETTINGS SCREEN
         ======================= -->
    <section id="screen-settings" class="screen z-30 bg-cn-cyan flex flex-col">
        <header class="bg-cn-yellow border-b-4 border-black p-4 flex items-center gap-3">
            <button onclick="nav.back()" class="bg-white text-black p-2 border-comic rounded-full hover:scale-110 transition-transform shadow-hard-sm">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="font-comic text-3xl tracking-wide">CONFIGURACIÓN</h2>
        </header>
        <div class="flex-1 p-6 overflow-y-auto">
            <div class="space-y-6">
                <div class="bg-white border-comic p-6 shadow-hard">
                    <h3 class="font-comic text-2xl mb-4 text-cn-magenta">CALIDAD DE EXPORTACIÓN</h3>
                    <select class="w-full p-4 border-comic font-ui font-bold text-lg shadow-hard-sm">
                        <option>Alta Calidad (PNG)</option>
                        <option>Calidad Media (JPG)</option>
                        <option>Compresión Máxima</option>
                    </select>
                </div>
                <div class="bg-white border-comic p-6 shadow-hard">
                    <h3 class="font-comic text-2xl mb-4 text-cn-magenta" data-translate="theme">TEMA DE LA APP</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="theme-classic" onclick="app.setTheme('classic')" class="theme-btn bg-cn-cyan text-white p-4 border-comic font-comic text-xl shadow-hard hover:translate-y-1 hover:shadow-none transition-all">
                            CLÁSICO
                        </button>
                        <button id="theme-retro" onclick="app.setTheme('retro')" class="theme-btn bg-cn-magenta text-white p-4 border-comic font-comic text-xl shadow-hard hover:translate-y-1 hover:shadow-none transition-all">
                            RETRO
                        </button>
                    </div>
                    <div class="mt-4 p-3 bg-gray-100 border-2 border-black">
                        <p class="font-ui font-bold text-sm text-center">Tema actual: <span id="current-theme" class="text-cn-magenta">CLÁSICO</span></p>
                    </div>
                </div>
                
                <div class="bg-white border-comic p-6 shadow-hard">
                    <h3 class="font-comic text-2xl mb-4 text-cn-magenta">IDIOMA</h3>
                    <select id="language-select" onchange="app.changeLanguage(this.value)" class="w-full p-4 border-comic font-ui font-bold text-lg shadow-hard-sm">
                        <option value="es">Español</option>
                        <option value="en">English</option>
                        <option value="fr">Français</option>
                        <option value="de">Deutsch</option>
                        <option value="pt">Português</option>
                        <option value="it">Italiano</option>
                    </select>
                </div>
            </div>
        </div>
    </section>

    <!-- =======================
         7. HELP SCREEN
         ======================= -->
    <section id="screen-help" class="screen z-30 bg-green-400 flex flex-col">
        <header class="bg-cn-yellow border-b-4 border-black p-4 flex items-center gap-3">
            <button onclick="nav.back()" class="bg-white text-black p-2 border-comic rounded-full hover:scale-110 transition-transform shadow-hard-sm">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="font-comic text-3xl tracking-wide">CENTRO DE AYUDA</h2>
        </header>
        <div class="flex-1 p-6 overflow-y-auto">
            <div class="space-y-6">
                <div class="bg-cn-yellow border-comic p-6 shadow-hard">
                    <h3 class="font-comic text-2xl mb-3">Cómo crear stickers</h3>
                    <p class="font-ui font-bold text-lg">1. Elige "Crear Stickers" o "Subir Foto"<br>2. Edita con las herramientas<br>3. Guarda tu creación</p>
                </div>
                <div class="bg-cn-cyan border-comic p-6 shadow-hard">
                    <h3 class="font-comic text-2xl mb-3 text-white">Consejos Pro</h3>
                    <p class="font-ui font-bold text-white text-lg">- Usa descripciones detalladas<br>- Combina texto y emojis<br>- Experimenta con colores</p>
                </div>
                <div class="bg-white border-comic p-6 shadow-hard">
                    <h3 class="font-comic text-2xl mb-3 text-cn-magenta">Gestos Táctiles</h3>
                    <p class="font-ui font-bold text-lg">- Toca para seleccionar<br>- Arrastra para mover<br>- Pellizca para escalar/rotar</p>
                </div>
            </div>
        </div>
    </section>

    <!-- =======================
         8. CONTACT SCREEN
         ======================= -->
    <section id="screen-contact" class="screen z-30 bg-cn-magenta flex flex-col">
        <header class="bg-cn-yellow border-b-4 border-black p-4 flex items-center gap-3">
            <button onclick="nav.back()" class="bg-white text-black p-2 border-comic rounded-full hover:scale-110 transition-transform shadow-hard-sm">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="font-comic text-3xl tracking-wide">CONTACTO</h2>
        </header>
        <div class="flex-1 p-6 overflow-y-auto">
            <div class="space-y-6">
                <div class="bg-cn-yellow border-comic p-6 text-center shadow-hard">
                    <i data-lucide="mail" class="w-20 h-20 mx-auto mb-4"></i>
                    <h3 class="font-comic text-3xl mb-3">REPORTAR PROBLEMA</h3>
                    <p class="font-ui font-bold mb-6 text-lg">Descíbenos qué pasó y te ayudaremos</p>
                    <button onclick="app.openEmail()" class="bg-cn-magenta text-white border-comic px-8 py-4 font-comic text-xl shadow-hard hover:translate-y-1 hover:shadow-none transition-all">
                        ENVIAR EMAIL
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- =======================
         9. RATE APP SCREEN
         ======================= -->
    <section id="screen-rate" class="screen z-30 bg-cn-yellow flex flex-col">
        <header class="bg-cn-magenta border-b-4 border-black p-4 flex items-center gap-3">
            <button onclick="nav.back()" class="bg-white text-black p-2 border-comic rounded-full hover:scale-110 transition-transform shadow-hard-sm">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="font-comic text-3xl tracking-wide text-white">CALIFICAR APP</h2>
        </header>
        <div class="flex-1 p-6 overflow-y-auto flex flex-col justify-center">
            <div class="text-center space-y-6">
                <div class="bg-white border-comic p-8 shadow-hard">
                    <i data-lucide="heart" class="w-24 h-24 mx-auto mb-4 text-red-500 fill-red-500"></i>
                    <h3 class="font-comic text-4xl mb-4 text-cn-magenta">¿TE GUSTA STICKERTOONS?</h3>
                    <p class="font-ui font-bold text-xl mb-6">¡Tu opinión nos ayuda a mejorar!</p>
                </div>
                
                <div class="bg-cn-cyan border-comic p-6 shadow-hard">
                    <h4 class="font-comic text-2xl mb-4 text-white">CALIFICA CON ESTRELLAS</h4>
                    <div class="flex justify-center gap-2 mb-6">
                        <button onclick="app.setRating(1)" class="star-btn text-4xl hover:scale-125 transition-transform">⭐</button>
                        <button onclick="app.setRating(2)" class="star-btn text-4xl hover:scale-125 transition-transform">⭐</button>
                        <button onclick="app.setRating(3)" class="star-btn text-4xl hover:scale-125 transition-transform">⭐</button>
                        <button onclick="app.setRating(4)" class="star-btn text-4xl hover:scale-125 transition-transform">⭐</button>
                        <button onclick="app.setRating(5)" class="star-btn text-4xl hover:scale-125 transition-transform">⭐</button>
                    </div>
                    <button onclick="app.submitRating()" class="bg-cn-yellow text-black border-comic px-8 py-4 font-comic text-xl shadow-hard hover:translate-y-1 hover:shadow-none transition-all">
                        ENVIAR CALIFICACIÓN
                    </button>
                </div>
                
                <div class="bg-cn-magenta border-comic p-6 shadow-hard">
                    <h4 class="font-comic text-2xl mb-4 text-white">COMPARTE CON AMIGOS</h4>
                    <button onclick="app.shareApp()" class="bg-white text-cn-magenta border-comic px-8 py-4 font-comic text-xl shadow-hard hover:translate-y-1 hover:shadow-none transition-all">
                        COMPARTIR APP
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- =======================
         10. ABOUT SCREEN
         ======================= -->
    <section id="screen-about" class="screen z-30 bg-cn-cyan flex flex-col">
        <header class="bg-cn-yellow border-b-4 border-black p-4 flex items-center gap-3">
            <button onclick="nav.back()" class="bg-white text-black p-2 border-comic rounded-full hover:scale-110 transition-transform shadow-hard-sm">
                <i data-lucide="arrow-left" class="w-6 h-6"></i>
            </button>
            <h2 class="font-comic text-3xl tracking-wide">ACERCA DE</h2>
        </header>
        <div class="flex-1 p-6 overflow-y-auto text-center">
            <div class="space-y-6">
                <div class="bg-cn-yellow border-comic p-8 shadow-hard">
                    <i data-lucide="zap" class="w-24 h-24 mx-auto mb-4 fill-cn-cyan text-black stroke-[3]"></i>
                    <h3 class="font-comic text-4xl mb-3">StickerToons</h3>
                    <p class="font-ui font-bold text-2xl">Versión 2.1</p>
                </div>
                <div class="bg-white border-comic p-6 shadow-hard">
                    <h4 class="font-comic text-2xl mb-4 text-cn-magenta">CREADO CON AMOR</h4>
                    <p class="font-ui font-bold text-lg">Una app para crear stickers increíbles con herramientas de edición intuitivas y generación automática.</p>
                </div>

                <div class="bg-white border-comic p-4 shadow-hard">
                    <p class="font-ui font-bold text-gray-600">© 2024 StickerToons. Todos los derechos reservados.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- =======================
         11. EDITOR SCREEN (CANVAS)
         ======================= -->
    <section id="screen-editor" class="screen z-30 bg-gray-100 flex flex-col">
        
        <!-- Editor Header -->
        <header class="bg-white border-b-4 border-black p-2 flex justify-between items-center shadow-md">
            <button onclick="nav.to('home')" class="bg-red-500 text-white p-2 border-2 border-black rounded shadow-sm">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <div class="flex gap-2">
                <!-- Se elimina el botón de undo ya que no tiene implementación -->
                <button onclick="app.clearCanvas()" class="p-2 border-2 border-black rounded hover:bg-red-200 text-red-600"><i data-lucide="trash-2"></i></button>
            </div>
            <button onclick="app.export()" class="bg-[#39B54A] text-white p-2 px-4 border-2 border-black rounded shadow-hard-sm font-comic text-lg">
                GUARDAR
            </button>
        </header>

        <!-- Canvas Area -->
        <div class="flex-1 relative p-4 flex items-center justify-center bg-gray-200 overflow-hidden">
            <div id="canvas-container" class="relative w-full h-full max-w-md max-h-[80vh] border-comic shadow-hard bg-white canvas-wrapper" style="min-height:320px;">
                <!-- touch-action none to allow custom gestures -->
                <canvas id="sticker-canvas" style="width:100%;height:100%;display:block;"></canvas>
            </div>
            
            <!-- Floating Controls for Selection -->
            <div id="selection-controls" class="absolute bottom-6 left-1/2 -translate-x-1/2 bg-white border-comic px-4 py-2 flex gap-4 shadow-hard hidden z-20">
                <button onclick="app.engine.removeBackground()" class="flex flex-col items-center gap-1 text-cn-magenta hover:scale-110 transition-transform">
                    <i data-lucide="wand-2" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold">FONDO</span>
                </button>
                <div class="w-0.5 bg-black h-8"></div>
                <button onclick="app.engine.moveToFront()" class="flex flex-col items-center gap-1 hover:scale-110 transition-transform">
                    <i data-lucide="arrow-up-to-line" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold">SUBIR</span>
                </button>
                <button onclick="app.engine.deleteObject()" class="flex flex-col items-center gap-1 text-red-600 hover:scale-110 transition-transform">
                    <i data-lucide="trash" class="w-6 h-6"></i>
                    <span class="text-[10px] font-bold">BORRAR</span>
                </button>
            </div>
        </div>

        <!-- Bottom Toolbar -->
        <div class="bg-cn-yellow border-t-4 border-black p-3 pb-6 flex justify-around">
            <button onclick="app.setMode('move')" class="tool-btn bg-white border-2 border-black p-3 rounded-lg shadow-sm active:bg-cn-cyan active:text-white transition-colors flex flex-col items-center w-16">
                <i data-lucide="hand" class="w-6 h-6"></i>
                <span class="font-comic text-sm mt-1">MOVER</span>
            </button>
            <button onclick="app.addText()" class="tool-btn bg-white border-2 border-black p-3 rounded-lg shadow-sm active:bg-cn-cyan active:text-white transition-colors flex flex-col items-center w-16">
                <i data-lucide="type" class="w-6 h-6"></i>
                <span class="font-comic text-sm mt-1">TEXTO</span>
            </button>
            <button onclick="app.addDeco()" class="tool-btn bg-white border-2 border-black p-3 rounded-lg shadow-sm active:bg-cn-cyan active:text-white transition-colors flex flex-col items-center w-16">
                <i data-lucide="sticker" class="w-6 h-6"></i>
                <span class="font-comic text-sm mt-1">DECO</span>
            </button>
        </div>
    </section>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCFQ_geG0HIv2EZ-bfKc97TJNtf2sdqPzc",
            authDomain: "clack-koder.firebaseapp.com",
            databaseURL: "https://clack-koder-default-rtdb.firebaseio.com",
            projectId: "clack-koder",
            storageBucket: "clack-koder.firebasestorage.app",
            messagingSenderId: "478151254938",
            appId: "1:478151254938:web:e2c00e3a5426bd192b9023",
            measurementId: "G-P29ME5Z3S1"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        
        // --- NAVIGATION CONTROLLER ---
        const nav = {
            history: ['splash'],
            to: function(screenId) {
                // Verificar existencia
                const target = document.getElementById('screen-' + screenId);
                if(!target) {
                    console.warn('Pantalla no encontrada:', screenId);
                    return;
                }

                // Ocultar todas las pantallas
                document.querySelectorAll('.screen').forEach(s => {
                    s.classList.remove('active');
                    s.style.opacity = 0;
                });

                target.classList.add('active');
                // Forzar repaint/animación suave
                setTimeout(() => target.style.opacity = 1, 50);

                // Ajustar canvas cuando se muestra el editor
                if (screenId === 'editor' && app.engine) {
                    // Small timeout to ensure layout settled
                    setTimeout(() => app.engine.resize(), 60);
                }

                // Historial básico
                const last = this.history[this.history.length - 1];
                if (!last || last !== screenId) {
                    this.history.push(screenId);
                }
            },
            back: function() {
                if (this.history.length > 1) {
                    // Quitar la pantalla actual
                    this.history.pop();
                    // Tomar la previa
                    const prev = this.history[this.history.length - 1] || 'home';
                    this.to(prev);
                } else {
                    this.to('home');
                }
            }
        };

        // --- STICKER ENGINE (Motor de Dibujo y Lógica) ---
        class StickerEngine {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                // willReadFrequently improves some pixel ops in modern browsers
                this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
                this.objects = []; 
                this.selection = -1; // índice del objeto seleccionado
                
                // Estado para gestos
                this.isDragging = false;
                this.lastPos = { x: 0, y: 0 };
                this.pinchDist = 0;
                this.pinchAngle = 0;

                this.setupEvents();
                // Inicial resize en caso de que el contenedor ya tenga tamaño
                setTimeout(()=> this.resize(), 80);
            }

            // Sincroniza las dimensiones internas del canvas con su contenedor y DPR
            resize() {
                const parent = this.canvas.parentElement;
                if (!parent) return;
                const rect = parent.getBoundingClientRect();
                if (rect.width === 0 || rect.height === 0) return; // evita tamaños 0 cuando está oculto

                const dpr = window.devicePixelRatio || 1;
                const w = Math.max(1, Math.round(rect.width * dpr));
                const h = Math.max(1, Math.round(rect.height * dpr));
                // ajustar canvas físico y CSS
                this.canvas.width = w;
                this.canvas.height = h;
                this.canvas.style.width = rect.width + 'px';
                this.canvas.style.height = rect.height + 'px';

                // Normalizar el sistema de coordenadas para trabajar en CSS pixels
                this.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                this.draw();
            }

            setupEvents() {
                // Eventos Touch (Móvil)
                this.canvas.addEventListener('touchstart', this.handleStart.bind(this), {passive: false});
                this.canvas.addEventListener('touchmove', this.handleMove.bind(this), {passive: false});
                this.canvas.addEventListener('touchend', this.handleEnd.bind(this), {passive: false});
                
                // Eventos Mouse (Desktop)
                this.canvas.addEventListener('mousedown', this.handleStart.bind(this));
                window.addEventListener('mousemove', this.handleMove.bind(this));
                window.addEventListener('mouseup', this.handleEnd.bind(this));

                // Para evitar gestos nativos conflictivos en algunos navegadores
                this.canvas.addEventListener('gesturestart', (e) => e.preventDefault());
            }

            addObject(obj) {
                // Normaliza la posición de inicio al centro (en CSS pixels)
                const rect = this.canvas.getBoundingClientRect();
                const newObj = {
                    x: rect.width / 2,
                    y: rect.height / 2,
                    rotation: 0,
                    scale: 1,
                    ...obj
                };
                this.objects.push(newObj);
                this.selection = this.objects.length - 1;
                this.draw();
                this.updateUI();
            }

            draw() {
                // Limpiar canvas en CSS pixels (context ya escalado por setTransform)
                const rect = this.canvas.getBoundingClientRect();
                this.ctx.clearRect(0, 0, rect.width, rect.height);
                
                this.objects.forEach((obj, idx) => {
                    this.ctx.save();
                    this.ctx.translate(obj.x, obj.y);
                    this.ctx.rotate(obj.rotation);
                    this.ctx.scale(obj.scale, obj.scale);

                    if (obj.type === 'img') {
                        this.ctx.drawImage(obj.img, -obj.width/2, -obj.height/2, obj.width, obj.height);
                    } else if (obj.type === 'text') {
                        // El font debe reestablecerse antes de dibujar
                        this.ctx.font = `bold ${obj.size}px Bangers`;
                        this.ctx.textAlign = 'center';
                        this.ctx.textBaseline = 'middle';
                        // Trazo (Stroke)
                        this.ctx.lineWidth = 5;
                        this.ctx.strokeStyle = 'black';
                        this.ctx.strokeText(obj.text, 0, 0);
                        // Relleno (Fill)
                        this.ctx.fillStyle = obj.color;
                        this.ctx.fillText(obj.text, 0, 0);
                    }

                    // Caja de Selección
                    if (idx === this.selection) {
                        let w = 100, h = 50; 
                        if (obj.type === 'img') {
                             w = obj.width; 
                             h = obj.height;
                        } else if (obj.type === 'text') {
                             // Reestablecer font para medir texto
                             this.ctx.font = `bold ${obj.size}px Bangers`; 
                             const metrics = this.ctx.measureText(obj.text);
                             w = metrics.width + 10;
                             h = obj.size + 10;
                        }
                        
                        this.ctx.strokeStyle = '#EC008C';
                        this.ctx.lineWidth = 2 / (obj.scale || 1);
                        this.ctx.setLineDash([10, 5]);
                        this.ctx.strokeRect((-w/2) - 10, (-h/2) - 10, w + 20, h + 20);
                        this.ctx.setLineDash([]);
                    }

                    this.ctx.restore();
                });
            }

            // Lógica de Gestos
            getPos(e) {
                const rect = this.canvas.getBoundingClientRect();
                let clientX, clientY;
                if (e.touches && e.touches[0]) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                return { 
                    x: clientX - rect.left, 
                    y: clientY - rect.top 
                };
            }

            handleStart(e) {
                if (e) e.preventDefault();
                const pos = this.getPos(e);

                // Detección de colisión (Hit detection) por distancia simple
                let clicked = -1;
                for(let i=this.objects.length-1; i>=0; i--) {
                    const obj = this.objects[i];
                    const dist = Math.hypot(pos.x - obj.x, pos.y - obj.y);
                    const radius = ((obj.width || obj.size || 100) * (obj.scale || 1)) / 2;
                    
                    // Mejoramos el área de detección para dispositivos móviles
                    if(dist < radius + 50) { 
                        clicked = i;
                        break;
                    }
                }

                this.selection = clicked;
                this.updateUI();
                
                if(clicked !== -1) {
                    this.isDragging = true;
                    this.lastPos = pos;
                    
                    // Inicialización de gestos de pinza (pinch/rotate)
                    if(e.touches && e.touches.length === 2) {
                        this.pinchDist = Math.hypot(
                            e.touches[0].clientX - e.touches[1].clientX,
                            e.touches[0].clientY - e.touches[1].clientY
                        );
                        this.pinchAngle = Math.atan2(
                            e.touches[1].clientY - e.touches[0].clientY,
                            e.touches[1].clientX - e.touches[0].clientX
                        );
                    }
                } else {
                    this.isDragging = false;
                }
                this.draw();
            }

            handleMove(e) {
                if (e) e.preventDefault();
                if(!this.isDragging || this.selection === -1) return;

                const obj = this.objects[this.selection];

                // Pinza / Rotación
                if(e.touches && e.touches.length === 2) {
                    const dist = Math.hypot(
                        e.touches[0].clientX - e.touches[1].clientX,
                        e.touches[0].clientY - e.touches[1].clientY
                    );
                    const angle = Math.atan2(
                        e.touches[1].clientY - e.touches[0].clientY,
                        e.touches[1].clientX - e.touches[0].clientX
                    );

                    if (this.pinchDist > 0) {
                        const scaleFactor = dist / this.pinchDist;
                        obj.scale = Math.max(0.2, Math.min(obj.scale * scaleFactor, 5));
                    }
                    obj.rotation += (angle - this.pinchAngle);

                    this.pinchDist = dist;
                    this.pinchAngle = angle;
                } else {
                    // Arrastre (Drag)
                    const pos = this.getPos(e);
                    obj.x += (pos.x - this.lastPos.x);
                    obj.y += (pos.y - this.lastPos.y);
                    this.lastPos = pos;
                }
                this.draw();
            }

            handleEnd(e) {
                if (e) e.preventDefault();
                this.isDragging = false;
                this.pinchDist = 0;
            }

            // Funcionalidades de edición
            removeBackground() {
                if(this.selection === -1) return;
                const obj = this.objects[this.selection];
                if(obj.type !== 'img') return;

                // Algoritmo mejorado de remoción de fondo
                const temp = document.createElement('canvas');
                temp.width = obj.width;
                temp.height = obj.height;
                const tCtx = temp.getContext('2d');
                tCtx.drawImage(obj.img, 0, 0, obj.width, obj.height);
                
                let imageData;
                try {
                    imageData = tCtx.getImageData(0, 0, temp.width, temp.height);
                } catch (err) {
                    console.warn('No se puede acceder a imageData (problema CORS).');
                    return;
                }
                const data = imageData.data;
                
                // Detectar color de fondo desde las esquinas
                const corners = [
                    [0, 0],
                    [temp.width - 1, 0],
                    [0, temp.height - 1],
                    [temp.width - 1, temp.height - 1]
                ];
                
                let avgR = 0, avgG = 0, avgB = 0;
                corners.forEach(([x, y]) => {
                    const idx = (y * temp.width + x) * 4;
                    avgR += data[idx];
                    avgG += data[idx + 1];
                    avgB += data[idx + 2];
                });
                
                avgR = Math.round(avgR / 4);
                avgG = Math.round(avgG / 4);
                avgB = Math.round(avgB / 4);
                
                const tolerance = 80; // Mayor tolerancia para mejores resultados

                for(let i = 0; i < data.length; i += 4) {
                    const dist = Math.sqrt(
                        (data[i] - avgR) ** 2 + 
                        (data[i + 1] - avgG) ** 2 + 
                        (data[i + 2] - avgB) ** 2
                    );
                    
                    if(dist < tolerance) { 
                        data[i + 3] = 0; // Transparente
                    } else if(dist < tolerance + 30) {
                        // Suavizar bordes
                        data[i + 3] = Math.round((dist - tolerance) / 30 * 255);
                    }
                }
                
                tCtx.putImageData(imageData, 0, 0);
                
                const newImg = new Image();
                newImg.src = temp.toDataURL();
                newImg.onload = () => {
                    obj.img = newImg;
                    this.draw();
                };
            }

            deleteObject() {
                if(this.selection !== -1) {
                    this.objects.splice(this.selection, 1);
                    this.selection = -1;
                    this.draw();
                    this.updateUI();
                }
            }
            
            moveToFront() {
                 if(this.selection !== -1) {
                    const obj = this.objects.splice(this.selection, 1)[0];
                    this.objects.push(obj);
                    this.selection = this.objects.length - 1;
                    this.draw();
                 }
            }

            updateUI() {
                // Muestra u oculta los controles de edición flotantes
                const controls = document.getElementById('selection-controls');
                if(this.selection !== -1) {
                    controls.classList.remove('hidden');
                    controls.classList.add('flex');
                } else {
                    controls.classList.add('hidden');
                    controls.classList.remove('flex');
                }
            }
        }

        // --- APP CONTROLLER ---
        const app = {
            apiKey: "",
            engine: null,
            savedStickers: [],
            referenceImage: null,
            generationMode: 'new',

            init: function() {
                // Lanzar icons lucide
                lucide.createIcons();

                // Instanciar motor y listeners
                this.engine = new StickerEngine('sticker-canvas');
                
                // Inicializar tema sin mostrar mensaje
                this.currentTheme = 'classic';
                document.body.style.filter = 'none';
                
                // Cargar idioma guardado
                const savedLang = localStorage.getItem('language') || 'es';
                const langSelect = document.getElementById('language-select');
                if (langSelect) langSelect.value = savedLang;
                this.currentLanguage = savedLang;
                
                // Actualizar iconos de lucide cuando se navega
                const originalNavTo = nav.to;
                nav.to = function(screenId) {
                    originalNavTo.call(this, screenId);
                    setTimeout(() => lucide.createIcons(), 100);
                };

                // Listener de resize global
                window.addEventListener('resize', () => {
                    if(this.engine) this.engine.resize();
                });

                // Ir directo al home después del splash (sin autenticación obligatoria)
                setTimeout(() => {
                    nav.to('home');
                    lucide.createIcons();
                }, 1200);

                // Interceptar navegación para funcionalidades especiales
                this.setupNavigation();
            },

            setupNavigation: function() {
                const originalNavTo = nav.to;
                nav.to = function(screenId) {
                    // Cargar galería cuando se abre
                    if (screenId === 'gallery') {
                        app.loadGallery();
                    }
                    
                    // Navegación normal
                    originalNavTo.call(this, screenId);
                };
            },

            handleUpload: function(e) {
                const file = e.target.files[0];
                if(!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => this.loadImageToEditor(ev.target.result);
                reader.readAsDataURL(file);
                // reset input for repeated uploads
                e.target.value = '';
            },

            loadImageToEditor: function(src) {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => {
                    // Normaliza el tamaño de la imagen para rendimiento
                    const temp = document.createElement('canvas');
                    const maxDim = 600;
                    const scale = Math.min(maxDim/img.width, maxDim/img.height, 1);
                    temp.width = Math.round(img.width * scale);
                    temp.height = Math.round(img.height * scale);
                    temp.getContext('2d').drawImage(img, 0, 0, temp.width, temp.height);

                    const finalImg = new Image();
                    finalImg.src = temp.toDataURL();
                    finalImg.onload = () => {
                        nav.to('editor');
                        // asegurar resize antes de añadir
                        setTimeout(() => {
                            this.engine.addObject({
                                type: 'img',
                                img: finalImg,
                                width: temp.width,
                                height: temp.height
                            });
                        }, 80);
                    };
                };
                img.onerror = () => {
                    this.showMessage('No se pudo cargar la imagen (posible problema CORS o archivo corrupto).');
                };
                img.src = src;
            },

            setPrompt: function(txt) {
                document.getElementById('ai-prompt').value = txt;
            },
            
            // Función para usar sticker de galería como referencia
            useAsReference: function(url) {
                this.referenceImage = url;
                document.getElementById('reference-img').src = url;
                document.getElementById('reference-preview').classList.remove('hidden');
                this.setGenerationMode('modify');
                nav.to('ai');
                this.showMessage('Imagen cargada como referencia. Describe los cambios que quieres hacer.', '#39B54A');
            },

            generateAI: async function() {
                const prompt = document.getElementById('ai-prompt').value.trim();
                if(!prompt) return this.showMessage('¡Escribe una descripción para generar un sticker!');

                const loader = document.getElementById('ai-loader');
                loader.classList.remove('hidden');
                lucide.createIcons();

                try {
                    let fullPrompt;
                    let imageUrl;
                    
                    if (this.generationMode === 'modify' && this.referenceImage) {
                        // Modo modificar: usar imagen de referencia
                        fullPrompt = encodeURIComponent(`${prompt}, based on reference image, sticker design, clean white background, high quality, cartoon style, vibrant colors, modifications and improvements`);
                        // Nota: Pollinations soporta img2img pero de forma limitada
                        imageUrl = `https://image.pollinations.ai/prompt/${fullPrompt}?width=1024&height=1024&model=flux&nologo=true&enhance=true&seed=${Math.floor(Math.random() * 1000000)}`;
                    } else {
                        // Modo nuevo: crear desde cero
                        fullPrompt = encodeURIComponent(`${prompt}, sticker design, clean white background, high quality, cartoon style, vibrant colors, simple shapes, vector art, no shadows, flat design, isolated object`);
                        imageUrl = `https://image.pollinations.ai/prompt/${fullPrompt}?width=1024&height=1024&seed=${Math.floor(Math.random() * 1000000)}&model=flux&nologo=true&enhance=true`;
                    }
                    
                    const response = await fetch(imageUrl);
                    if (!response.ok) throw new Error('Error en la respuesta');
                    
                    const blob = await response.blob();
                    const objectUrl = URL.createObjectURL(blob);
                    
                    const img = new Image();
                    img.onload = () => {
                        loader.classList.add('hidden');
                        this.loadImageToEditor(objectUrl);
                    };
                    
                    img.onerror = () => {
                        loader.classList.add('hidden');
                        this.showMessage('Error al cargar imagen. Inténtalo de nuevo.');
                    };
                    
                    img.src = objectUrl;
                    
                } catch(e) {
                    console.error("AI Generation Error:", e);
                    loader.classList.add('hidden');
                    this.showMessage('Error al generar imagen. Verifica tu conexión e intenta de nuevo.');
                }
            },
            
            // Funciones de imagen de referencia
            loadReference: function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (ev) => {
                    this.referenceImage = ev.target.result;
                    document.getElementById('reference-img').src = ev.target.result;
                    document.getElementById('reference-preview').classList.remove('hidden');
                    this.showMessage('Imagen de referencia cargada', '#39B54A');
                };
                reader.readAsDataURL(file);
                e.target.value = '';
            },
            
            clearReference: function() {
                this.referenceImage = null;
                document.getElementById('reference-preview').classList.add('hidden');
                document.getElementById('reference-input').value = '';
            },
            
            setGenerationMode: function(mode) {
                this.generationMode = mode;
                
                // Actualizar UI
                document.querySelectorAll('.generation-mode').forEach(btn => {
                    btn.classList.remove('active', 'bg-cn-cyan', 'text-white');
                    btn.classList.add('bg-gray-300', 'text-black');
                });
                
                const activeBtn = document.getElementById(`mode-${mode}`);
                activeBtn.classList.add('active', 'bg-cn-cyan', 'text-white');
                activeBtn.classList.remove('bg-gray-300', 'text-black');
                
                // Actualizar descripción
                const descriptions = {
                    'new': 'Crear un sticker completamente nuevo',
                    'modify': 'Modificar o agregar elementos a la imagen de referencia'
                };
                
                document.getElementById('mode-description').textContent = descriptions[mode];
                
                // Si no hay referencia en modo modificar, mostrar aviso
                if (mode === 'modify' && !this.referenceImage) {
                    this.showMessage('Sube una imagen de referencia para usar este modo');
                }
            },


            addText: function() {
                this.showPrompt("Escribe el texto de tu Sticker", "BOOM!", (t) => {
                    if(t) {
                        this.engine.addObject({
                            type: 'text',
                            text: t,
                            size: 60,
                            color: '#FFF200'
                        });
                    }
                });
            },
            
            addDeco: function() {
                this.showPrompt("Introduce un Emoji de decoración", "🔥", (t) => {
                    if(t) {
                        this.engine.addObject({
                            type: 'text',
                            text: t,
                            size: 80,
                            color: 'white'
                        });
                    }
                });
            },

            clearCanvas: function() {
                this.showConfirm("¿Estás seguro de que quieres borrar todos los elementos del lienzo? ¡Esta acción no se puede deshacer!", () => {
                    this.engine.objects = [];
                    this.engine.selection = -1;
                    this.engine.draw();
                    this.engine.updateUI();
                    this.showMessage("Lienzo borrado.", '#39B54A');
                });
            },

            export: async function() {
                this.engine.selection = -1;
                this.engine.draw();
                const url = this.engine.canvas.toDataURL('image/png');
                
                // Guardar en la galería
                this.saveToGallery(url);
                
                if(navigator.share && navigator.canShare && navigator.canShare({ files: [] })) {
                    try {
                        const blob = await (await fetch(url)).blob();
                        const file = new File([blob], 'sticker.png', {type:'image/png'});
                        await navigator.share({files: [file], title: 'Mi StickerToons'});
                        return;
                    } catch(e) {
                        console.warn('Share falló, haciendo fallback a descarga', e);
                    }
                }
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sticker.png';
                a.click();
                this.showMessage("¡Sticker guardado! Revisa 'Mis Creaciones'.", '#39B54A');
            },
            
            // Funciones de galería
            saveToGallery: function(imageUrl) {
                const sticker = {
                    id: Date.now(),
                    url: imageUrl,
                    date: new Date().toLocaleDateString()
                };
                
                this.savedStickers.unshift(sticker);
                
                // Guardar en localStorage
                try {
                    localStorage.setItem('stickertoons_gallery', JSON.stringify(this.savedStickers));
                } catch(e) {
                    console.warn('No se pudo guardar en localStorage', e);
                }
            },
            
            loadGallery: function() {
                // Cargar desde localStorage
                try {
                    const saved = localStorage.getItem('stickertoons_gallery');
                    if (saved) {
                        this.savedStickers = JSON.parse(saved);
                    }
                } catch(e) {
                    console.warn('Error al cargar galería', e);
                }
                
                const container = document.getElementById('gallery-content');
                const emptyMsg = document.getElementById('empty-gallery');
                
                if (this.savedStickers.length === 0) {
                    container.classList.add('hidden');
                    emptyMsg.classList.remove('hidden');
                    lucide.createIcons();
                    return;
                }
                
                container.classList.remove('hidden');
                emptyMsg.classList.add('hidden');
                container.innerHTML = '';
                
                this.savedStickers.forEach(sticker => {
                    const card = document.createElement('div');
                    card.className = 'bg-white border-comic shadow-hard overflow-hidden cursor-pointer hover:scale-105 transition-transform';
                    card.innerHTML = `
                        <img src="${sticker.url}" class="w-full h-40 object-contain bg-gray-100" alt="Sticker">
                        <div class="p-2 flex justify-between items-center">
                            <span class="font-ui text-xs font-bold text-gray-600">${sticker.date}</span>
                            <button onclick="app.deleteSticker(${sticker.id}); event.stopPropagation();" class="text-red-500 hover:scale-110 transition-transform">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;
                    
                    card.onclick = () => this.viewSticker(sticker.url);
                    container.appendChild(card);
                });
                
                lucide.createIcons();
            },
            
            deleteSticker: function(id) {
                this.showConfirm('¿Eliminar este sticker?', () => {
                    this.savedStickers = this.savedStickers.filter(s => s.id !== id);
                    localStorage.setItem('stickertoons_gallery', JSON.stringify(this.savedStickers));
                    this.loadGallery();
                });
            },
            
            viewSticker: function(url) {
                const el = document.createElement('div');
                el.className = 'fixed inset-0 bg-black/80 flex items-center justify-center z-[100] p-4';
                el.innerHTML = `
                    <div class="bg-white border-comic p-4 shadow-hard max-w-md w-full">
                        <img src="${url}" class="w-full border-2 border-black mb-4" alt="Sticker">
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <button onclick="app.downloadSticker('${url}')" class="bg-cn-cyan text-white border-comic px-4 py-3 font-comic text-lg shadow-hard-sm hover:bg-cyan-400">
                                DESCARGAR
                            </button>
                            <button onclick="app.useAsReference('${url}'); this.parentElement.parentElement.parentElement.remove();" class="bg-cn-magenta text-white border-comic px-4 py-3 font-comic text-lg shadow-hard-sm hover:bg-pink-600">
                                MODIFICAR
                            </button>
                        </div>
                        <button onclick="this.parentElement.parentElement.remove()" class="w-full bg-gray-300 text-black border-comic px-4 py-3 font-comic text-lg shadow-hard-sm hover:bg-gray-400">
                            CERRAR
                        </button>
                    </div>
                `;
                document.body.appendChild(el);
                el.onclick = (e) => {
                    if (e.target === el) el.remove();
                };
            },
            
            downloadSticker: function(url) {
                const a = document.createElement('a');
                a.href = url;
                a.download = `sticker_${Date.now()}.png`;
                a.click();
                this.showMessage('Sticker descargado!', '#39B54A');
            },
            
            // Funciones de autenticación
            login: async function() {
                const email = document.getElementById('login-email').value.trim();
                const password = document.getElementById('login-password').value;
                
                if (!email || !password) {
                    return this.showMessage('Completa todos los campos');
                }
                
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    nav.to('home');
                    this.showMessage('Bienvenido!', '#39B54A');
                } catch(e) {
                    this.showMessage('Error: ' + e.message);
                }
            },
            
            register: async function() {
                const email = document.getElementById('register-email').value.trim();
                const password = document.getElementById('register-password').value;
                const confirm = document.getElementById('register-confirm').value;
                
                if (!email || !password || !confirm) {
                    return this.showMessage('Completa todos los campos');
                }
                
                if (password !== confirm) {
                    return this.showMessage('Las contraseñas no coinciden');
                }
                
                if (password.length < 6) {
                    return this.showMessage('La contraseña debe tener al menos 6 caracteres');
                }
                
                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                    nav.to('home');
                    this.showMessage('Cuenta creada exitosamente!', '#39B54A');
                } catch(e) {
                    this.showMessage('Error: ' + e.message);
                }
            },
            
            showRegister: function() {
                document.getElementById('login-form').classList.add('hidden');
                document.getElementById('register-form').classList.remove('hidden');
            },
            
            showLogin: function() {
                document.getElementById('register-form').classList.add('hidden');
                document.getElementById('login-form').classList.remove('hidden');
            },
            
            resetPassword: function() {
                this.showPrompt('Ingresa tu email para recuperar tu contraseña', 'email@ejemplo.com', async (email) => {
                    if (!email) return;
                    
                    try {
                        await auth.sendPasswordResetEmail(email);
                        this.showMessage('Email de recuperación enviado. Revisa tu bandeja.', '#39B54A');
                    } catch(e) {
                        this.showMessage('Error: ' + e.message);
                    }
                });
            },
            
            logout: function() {
                this.showConfirm('¿Cerrar sesión?', async () => {
                    await auth.signOut();
                    nav.to('login');
                    this.showMessage('Sesión cerrada', '#39B54A');
                });
            },
            
            // Sistema de traducción
            currentLanguage: 'es',
            
            changeLanguage: async function(lang) {
                this.currentLanguage = lang;
                localStorage.setItem('language', lang);
                
                // Traducir textos principales
                const textsToTranslate = {
                    'es': {
                        welcome: 'BIENVENIDO',
                        login: 'ENTRAR',
                        register: 'REGISTRARSE',
                        forgot: '¿Olvidaste tu contraseña?',
                        menu: 'MENÚ',
                        settings: 'AJUSTES',
                        help: 'AYUDA',
                        contact: 'CONTACTO',
                        rate: 'CALIFICAR APP',
                        about: 'ACERCA DE'
                    },
                    'en': {
                        welcome: 'WELCOME',
                        login: 'LOGIN',
                        register: 'SIGN UP',
                        forgot: 'Forgot password?',
                        menu: 'MENU',
                        settings: 'SETTINGS',
                        help: 'HELP',
                        contact: 'CONTACT',
                        rate: 'RATE APP',
                        about: 'ABOUT'
                    },
                    'fr': {
                        welcome: 'BIENVENUE',
                        login: 'CONNEXION',
                        register: 'S\'INSCRIRE',
                        forgot: 'Mot de passe oublié?',
                        menu: 'MENU',
                        settings: 'PARAMÈTRES',
                        help: 'AIDE',
                        contact: 'CONTACT',
                        rate: 'ÉVALUER',
                        about: 'À PROPOS'
                    }
                };
                
                const texts = textsToTranslate[lang] || textsToTranslate['es'];
                
                // Aplicar traducciones básicas
                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.getAttribute('data-translate');
                    if (texts[key]) el.textContent = texts[key];
                });
                
                this.showMessage('Idioma cambiado', '#39B54A');
            },
            
            // Funciones de Modales Personalizados (Reemplazando alerts/confirms/prompts)
            showMessage: function(msg, bgColor) {
                const el = document.createElement('div');
                el.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[100]';
                const bg = bgColor || 'white';
                el.innerHTML = `
                    <div class="border-comic p-6 shadow-hard pop-in max-w-xs w-full text-center" style="background:${bg};">
                        <p class="font-ui font-bold mb-4">${msg}</p>
                        <button id="msg-ok" class="bg-cn-cyan text-white border-comic shadow-hard-sm px-4 py-2 font-comic text-lg hover:bg-cyan-400">¡ENTENDIDO!</button>
                    </div>
                `;
                document.body.appendChild(el);
                document.getElementById('msg-ok').onclick = () => document.body.removeChild(el);
            },
            
            showConfirm: function(msg, onConfirm) {
                const el = document.createElement('div');
                el.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[100]';
                el.innerHTML = `
                    <div class="bg-white border-comic p-6 shadow-hard pop-in max-w-xs w-full text-center">
                        <p class="font-ui font-bold mb-4">${msg}</p>
                        <div class="flex justify-center gap-4">
                            <button id="confirm-ok" class="bg-red-500 text-white border-comic shadow-hard-sm px-4 py-2 font-comic text-lg hover:bg-red-600">SÍ</button>
                            <button id="confirm-cancel" class="bg-gray-300 text-black border-comic shadow-hard-sm px-4 py-2 font-comic text-lg hover:bg-gray-400">NO</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(el);

                document.getElementById('confirm-ok').onclick = () => {
                    onConfirm();
                    document.body.removeChild(el);
                };
                
                document.getElementById('confirm-cancel').onclick = () => {
                    document.body.removeChild(el);
                };
            },
            
            showPrompt: function(msg, placeholder, onResult) {
                const el = document.createElement('div');
                el.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-[100]';
                el.innerHTML = `
                    <div class="bg-cn-yellow border-comic p-6 shadow-hard pop-in max-w-xs w-full text-center">
                        <p class="font-comic text-xl mb-4">${msg}</p>
                        <input id="prompt-input" type="text" placeholder="${placeholder}" class="comic-input w-full p-3 mb-4 rounded-none text-center">
                        <div class="flex justify-center gap-4">
                            <button id="prompt-ok" class="bg-cn-cyan text-white border-comic shadow-hard-sm px-4 py-2 font-comic text-lg hover:bg-cyan-400">ACEPTAR</button>
                            <button id="prompt-cancel" class="bg-gray-300 text-black border-comic shadow-hard-sm px-4 py-2 font-comic text-lg hover:bg-gray-400">CANCELAR</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(el);
                
                const input = document.getElementById('prompt-input');
                setTimeout(() => input.focus(), 50);
                
                document.getElementById('prompt-ok').onclick = () => {
                    onResult(input.value);
                    document.body.removeChild(el);
                };
                
                document.getElementById('prompt-cancel').onclick = () => {
                    onResult(null);
                    document.body.removeChild(el);
                };
            },

            // Funciones para las nuevas secciones del menú
            openEmail: function() {
                const subject = encodeURIComponent('Soporte StickerToons - Reporte de Problema');
                const body = encodeURIComponent('Hola,\n\nTengo un problema con StickerToons:\n\n[Describe tu problema aquí]\n\nGracias!');
                window.open(`mailto:soporte@stickertoons.com?subject=${subject}&body=${body}`);
            },

            // Funciones para calificar app
            currentRating: 0,
            
            setRating: function(stars) {
                this.currentRating = stars;
                // Actualizar visualización de estrellas
                document.querySelectorAll('.star-btn').forEach((btn, index) => {
                    if (index < stars) {
                        btn.style.filter = 'brightness(1.2) drop-shadow(0 0 10px gold)';
                    } else {
                        btn.style.filter = 'brightness(0.7)';
                    }
                });
            },
            
            submitRating: function() {
                if (this.currentRating === 0) {
                    this.showMessage('Por favor selecciona una calificación primero');
                    return;
                }
                this.showMessage(`¡Gracias por calificarnos con ${this.currentRating} estrellas!`, '#39B54A');
            },
            
            shareApp: function() {
                if (navigator.share) {
                    navigator.share({
                        title: 'StickerToons - Creador de Stickers',
                        text: '¡Crea stickers increíbles con IA!',
                        url: window.location.href
                    });
                } else {
                    this.showMessage('¡Comparte StickerToons con tus amigos!');
                }
            },

            // Sistema de temas
            currentTheme: 'classic',
            
            setTheme: function(theme) {
                this.currentTheme = theme;
                
                // Actualizar indicador visual de botones
                const buttons = document.querySelectorAll('.theme-btn');
                buttons.forEach(btn => {
                    btn.style.transform = 'scale(1)';
                    btn.style.boxShadow = '6px 6px 0px 0px #000000';
                });
                
                const selectedBtn = document.getElementById(`theme-${theme}`);
                if (selectedBtn) {
                    selectedBtn.style.transform = 'scale(0.95) translateY(2px)';
                    selectedBtn.style.boxShadow = '2px 2px 0px 0px #000000';
                }
                
                // Actualizar texto del tema actual
                const themeText = document.getElementById('current-theme');
                if (themeText) {
                    themeText.textContent = theme === 'classic' ? 'CLÁSICO' : 'RETRO';
                }
                
                // Aplicar cambios de tema
                if (theme === 'retro') {
                    document.body.style.filter = 'sepia(0.3) saturate(1.2)';
                    this.showMessage('Tema RETRO activado! Colores vintage aplicados.', '#FF6B35');
                } else {
                    document.body.style.filter = 'none';
                    this.showMessage('Tema CLÁSICO activado! Colores vibrantes restaurados.', '#00AEEF');
                }
            },

            showTemplates: function() {
                this.showMessage('Próximamente: Plantillas prediseñadas para crear stickers rápidamente!');
            },



            showExportSettings: function() {
                this.showMessage('Próximamente: Configuración avanzada de exportación!');
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>
